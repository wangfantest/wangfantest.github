---
title: "反编译之分支流程图的生成"
date: 2021-05-16
tags: ["Branch"]
categories: ["反编译"]
---

### 递归下降分析法

如果我们需要对某一段代码进行流程分析，那么首先需要思考一下这些代码有什么特点。

这些代码有一个非常重要的特点是，cpu执行指令的时候默认逻辑是按照地址从上往下执行的.

我们可以根据这个特定，来制定一个递归下降分析代码的算法。

首先，对cpu指令进行以下几种分类:

- 普通指令(push,call)
- 无条件跳转指令(jmp)
- 条件跳转指令(jcc)
- 结束指令(ret)



**分析引擎的关键点如下:**
1、循环从地址分析队列中取出最新的一个地址，进行解析，直到分析队列为空。

2、如果当前地址所处的指令为普通指令，压入此指令的下一条指令至分析队列，结束分析。

如果当前地址所处的指令为无条件跳转指令，压入此指令的跳转地址至分析队列，结束分析。

如果当前地址所处的指令为条件跳转指令，压入此指令的跳转地址和此指令的下一条指令至分析队列，结束分析。

如果当前地址所处的指令为结束指令，结束分析

3、分析地址的时候需要对已分析过的地址进行记录，由于我们是按照指令的执行顺序递归向下进行分析的，那么不难得出如果一个地址已经分析过，这个地址后面的所有地址必然全都分析过的结论。

通过上面这几点，我们很容易编写出一个简单的流程分析引擎。



另外我们还需要对代码进行分块，那么就需要了解到一些关于基本块(BasicBlock)的基本概念。

BasicBlock定义:

- 只有一个入口指令，一个出口指令
- 执行时从入口指令进入，从出口指令退出

基本块的一个典型特点是：只要基本块中第一条指令被执行了，那么基本块内的代码都将按照顺序执行有且仅有一次。

**划分BasicBlock的关键点:**

1、在上述分析引擎的基础上，按照顺序进行指令分析。

2、如果当前地址是普通指令，且不在任何基本块中，则添加当前地址至当前的基本块中，继续向下分析。

如果当前地址是是普通指令，但已处于某个基本块中，则结束分析。

如果当前地址是跳转指令,且跳转地址在已生成的Block代码之内，则将之前的Block块分割成至多两块。

如果当前地址是跳转指令,且跳转地址不在基本块中，则结束当前的Block，并将新地址作为Block的头部。

如果当前地址是结束指令，结束分析。

3、代码是否处于基本块中与代码是否分析过等价。



#### 必经节点(dominators)

在程序流图中，对任意两个节点m和n，如果从流图的首节点出发，到达n的任一通路都要经过m，则称m是n的必经节点，记为m DOM n。

#### 回边(back edge)

假设a->b是流图中的一条有向边，如果b DOM a，则称a->b是流图中的一条回边。



### 基本分支类型

1、第一种是if，流程图如下:



2、第二种是if-else，流程图如下:



3、第三种是do-while，流程图如下:



4、第四种是while-do，流程图如下:



5、第五种是switch，流程图如下:

